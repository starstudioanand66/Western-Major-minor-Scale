<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Piano: Major & Minor Scale Visualizer</title>
    <style>
        :root {
            --bg-color: #1a1a1d;
            --panel-color: #2c2c30;
            --text-color: #e0e0e0;
            --accent-color: #4db8ff;
            --accent-glow: rgba(77, 184, 255, 0.4);
            --key-white: #fffff0;
            --key-black: #111;
            --key-active: #ff9d00;
            --key-active-text: #fff;
        }

        * {
            box-sizing: border-box;
            user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- Header & Display --- */
        header {
            width: 100%;
            padding: 20px;
            text-align: center;
            background: linear-gradient(to bottom, #000000, var(--bg-color));
            border-bottom: 1px solid #333;
            margin-bottom: 20px;
        }

        h1 {
            margin: 0 0 10px 0;
            font-size: 1.8rem;
            letter-spacing: 2px;
            color: var(--accent-color);
            text-transform: uppercase;
        }

        #display-panel {
            background-color: var(--panel-color);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            min-width: 300px;
            max-width: 800px;
            width: 90%;
            text-align: center;
            border: 1px solid #444;
            transition: border-color 0.3s;
        }

        #display-panel.playing {
            border-color: var(--accent-color);
            box-shadow: 0 0 20px var(--accent-glow);
        }

        .scale-names {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 10px;
        }

        #western-name {
            font-size: 2.5rem;
            font-weight: bold;
            color: #fff;
        }

        #carnatic-name {
            font-size: 1.4rem;
            color: #aaa;
            font-style: italic;
        }

        #current-note {
            font-family: monospace;
            font-size: 1.2rem;
            color: var(--accent-color);
            height: 1.5em;
        }

        /* --- Controls --- */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
            padding: 0 20px;
            width: 100%;
            max-width: 900px;
        }

        .control-group {
            background-color: var(--panel-color);
            padding: 10px 20px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        label {
            font-size: 0.9rem;
            color: #ccc;
        }

        select, button {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #555;
            background-color: #3a3a3e;
            color: white;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
            outline: none;
        }

        select:hover, button:hover {
            background-color: #4a4a4e;
            border-color: #777;
        }

        button.primary {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            color: #000;
            font-weight: bold;
            padding: 10px 24px;
        }

        button.primary:hover {
            background-color: #3da1e0;
            box-shadow: 0 0 10px var(--accent-glow);
        }

        button.stop {
            background-color: #ff4d4d;
            border-color: #ff4d4d;
            color: white;
        }
        
        button.stop:hover {
            background-color: #e03c3c;
        }

        /* --- Piano Keyboard --- */
        .piano-wrapper {
            position: relative;
            padding: 20px;
            background: #222;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            margin-bottom: 40px;
            overflow-x: auto;
            max-width: 100%;
            display: flex;
            justify-content: center;
        }

        .piano {
            position: relative;
            display: flex;
            height: 240px;
            min-width: 1100px; 
        }

        .key {
            position: relative;
            cursor: pointer;
            border-radius: 0 0 5px 5px;
            transition: background 0.1s, transform 0.05s;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 10px;
            font-size: 0.8rem;
            font-weight: bold;
            color: #555;
            user-select: none;
        }

        .key.white {
            width: 50px;
            height: 100%;
            background: linear-gradient(to bottom, #fff 0%, #eee 100%);
            border: 1px solid #999;
            border-top: none;
            z-index: 1;
            box-shadow: inset 0 -5px 10px rgba(0,0,0,0.1);
        }

        .key.black {
            width: 34px;
            height: 60%;
            background: linear-gradient(to bottom, #333 0%, #000 100%);
            position: absolute;
            z-index: 2;
            border: 1px solid #000;
            border-top: none;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
            color: #888;
        }

        .key.white.active {
            background: var(--accent-color);
            transform: translateY(2px);
            box-shadow: 0 0 15px var(--accent-color);
            color: var(--key-active-text);
        }

        .key.black.active {
            background: var(--accent-color);
            color: var(--key-active-text);
            box-shadow: 0 0 15px var(--accent-color);
        }

        @media (max-width: 768px) {
            #western-name { font-size: 1.8rem; }
            .piano { height: 180px; min-width: 100%; justify-content: flex-start; }
            .key.white { width: 40px; }
            .key.black { width: 28px; }
        }
    </style>
</head>
<body>

    <header>
        <h1>Virtuoso 2D (Major & Minor)</h1>
        <div style="font-size: 0.9rem; color: #888;">Web Audio Synthesizer & Scale Tutor</div>
    </header>

    <div id="display-panel">
        <div class="scale-names">
            <div id="western-name">Ready</div>
            <div id="carnatic-name">Select a scale and press Play</div>
        </div>
        <div id="current-note"></div>
    </div>

    <div class="controls">
        <!-- Scale Selector -->
        <div class="control-group">
            <label for="scale-select">Scale</label>
            <select id="scale-select">
                <!-- Populated by JS -->
            </select>
        </div>

        <!-- Instrument Selector -->
        <div class="control-group">
            <label for="instrument">Instrument</label>
            <select id="instrument">
                <option value="piano">Grand Piano</option>
                <option value="violin">Violin</option>
                <option value="flute">Flute</option>
                <option value="strings">Strings</option>
            </select>
        </div>

        <!-- Playback Controls -->
        <div class="control-group">
            <button id="btn-play" class="primary">Play Selected</button>
            <button id="btn-stop" class="stop">Stop</button>
        </div>

        <!-- Speed Control -->
        <div class="control-group">
            <label for="speed">Speed (BPM)</label>
            <input type="range" id="speed" min="60" max="300" value="120" style="width: 100px;">
            <span id="speed-display">120</span>
        </div>
    </div>

    <div class="piano-wrapper">
        <div id="piano" class="piano">
            <!-- Keys generated by JS -->
        </div>
    </div>

<script>
/**
 * Music Data & Configuration
 */
const NOTES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

// Intervals for Major Scale (W-W-H-W-W-W-H)
const INTERVALS_MAJOR = [0, 2, 4, 5, 7, 9, 11, 12];

// Intervals for Natural Minor Scale (W-H-W-W-H-W-W)
const INTERVALS_MINOR = [0, 2, 3, 5, 7, 8, 10, 12];

// Construct Scale Data
// 12 Major Scales
const MAJOR_SCALES = [
    { root: 'C', name: 'C Major', type: 'major', carnatic: 'Sankarabharanam (Mela 29) - Sa: C' },
    { root: 'C#', name: 'C# Major', type: 'major', carnatic: 'Sankarabharanam - Sa: C#' },
    { root: 'D', name: 'D Major', type: 'major', carnatic: 'Sankarabharanam - Sa: D' },
    { root: 'D#', name: 'D# Major', type: 'major', carnatic: 'Sankarabharanam - Sa: D#' },
    { root: 'E', name: 'E Major', type: 'major', carnatic: 'Sankarabharanam - Sa: E' },
    { root: 'F', name: 'F Major', type: 'major', carnatic: 'Sankarabharanam - Sa: F' },
    { root: 'F#', name: 'F# Major', type: 'major', carnatic: 'Sankarabharanam - Sa: F#' },
    { root: 'G', name: 'G Major', type: 'major', carnatic: 'Sankarabharanam - Sa: G' },
    { root: 'G#', name: 'G# Major', type: 'major', carnatic: 'Sankarabharanam - Sa: G#' },
    { root: 'A', name: 'A Major', type: 'major', carnatic: 'Sankarabharanam - Sa: A' },
    { root: 'A#', name: 'A# Major', type: 'major', carnatic: 'Sankarabharanam - Sa: A#' },
    { root: 'B', name: 'B Major', type: 'major', carnatic: 'Sankarabharanam - Sa: B' }
];

// 12 Natural Minor Scales (Relative Minors)
// Formula: Start on the 6th degree of the Major scale.
const MINOR_SCALES = [
    { root: 'A', name: 'A Minor (Relative of C)', type: 'minor', carnatic: 'Natabhairavi (Mela 20) - Sa: A' },
    { root: 'A#', name: 'A# Minor (Relative of C#)', type: 'minor', carnatic: 'Natabhairavi - Sa: A#' },
    { root: 'B', name: 'B Minor (Relative of D)', type: 'minor', carnatic: 'Natabhairavi - Sa: B' },
    { root: 'C', name: 'C Minor (Relative of D#)', type: 'minor', carnatic: 'Natabhairavi - Sa: C' },
    { root: 'C#', name: 'C# Minor (Relative of E)', type: 'minor', carnatic: 'Natabhairavi - Sa: C#' },
    { root: 'D', name: 'D Minor (Relative of F)', type: 'minor', carnatic: 'Natabhairavi - Sa: D' },
    { root: 'D#', name: 'D# Minor (Relative of F#)', type: 'minor', carnatic: 'Natabhairavi - Sa: D#' },
    { root: 'E', name: 'E Minor (Relative of G)', type: 'minor', carnatic: 'Natabhairavi - Sa: E' },
    { root: 'F', name: 'F Minor (Relative of G#)', type: 'minor', carnatic: 'Natabhairavi - Sa: F' },
    { root: 'F#', name: 'F# Minor (Relative of A)', type: 'minor', carnatic: 'Natabhairavi - Sa: F#' },
    { root: 'G', name: 'G Minor (Relative of A#)', type: 'minor', carnatic: 'Natabhairavi - Sa: G' },
    { root: 'G#', name: 'G# Minor (Relative of B)', type: 'minor', carnatic: 'Natabhairavi - Sa: G#' }
];

// Combine them
const SCALES = [...MAJOR_SCALES, ...MINOR_SCALES];

/**
 * Audio Engine using Web Audio API
 */
class AudioEngine {
    constructor() {
        this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        this.masterGain = this.ctx.createGain();
        this.masterGain.gain.value = 0.5;
        this.masterGain.connect(this.ctx.destination);
        this.instrument = 'piano';
    }

    setInstrument(name) {
        this.instrument = name;
    }

    getFrequency(note, octave) {
        const noteIndex = NOTES.indexOf(note);
        const midi = (octave + 1) * 12 + noteIndex;
        return 440 * Math.pow(2, (midi - 69) / 12);
    }

    playTone(note, octave, duration) {
        if (this.ctx.state === 'suspended') {
            this.ctx.resume();
        }

        const freq = this.getFrequency(note, octave);
        const now = this.ctx.currentTime;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();

        osc.connect(gain);
        gain.connect(this.masterGain);

        const inst = this.instrument;

        if (inst === 'piano') {
            osc.type = 'triangle';
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(0.8, now + 0.02);
            gain.gain.exponentialRampToValueAtTime(0.01, now + duration);
            osc.frequency.value = freq;
            osc.start(now);
            osc.stop(now + duration + 0.1);

        } else if (inst === 'violin') {
            osc.type = 'sawtooth';
            
            const lfo = this.ctx.createOscillator();
            lfo.type = 'sine';
            lfo.frequency.value = 6.0;
            const lfoGain = this.ctx.createGain();
            lfoGain.gain.value = 4.0;
            lfo.connect(lfoGain);
            lfoGain.connect(osc.frequency);
            lfo.start(now);
            lfo.stop(now + duration + 0.5);

            osc.frequency.value = freq;
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(0.6, now + 0.2);
            gain.gain.setValueAtTime(0.6, now + duration - 0.1);
            gain.gain.linearRampToValueAtTime(0, now + duration);
            osc.start(now);
            osc.stop(now + duration + 0.5);

        } else if (inst === 'flute') {
            osc.type = 'sine'; 
            const osc2 = this.ctx.createOscillator();
            osc2.type = 'triangle';
            osc2.frequency.value = freq;
            const gain2 = this.ctx.createGain();
            gain2.gain.value = 0.1;
            osc2.connect(gain2);
            gain2.connect(this.masterGain);

            osc.frequency.value = freq;
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(0.5, now + 0.1);
            gain.gain.setValueAtTime(0.4, now + duration - 0.1);
            gain.gain.linearRampToValueAtTime(0, now + duration);

            osc.start(now);
            osc.stop(now + duration + 0.1);
            osc2.start(now);
            osc2.stop(now + duration + 0.1);

        } else if (inst === 'strings') {
            const filter = this.ctx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.setValueAtTime(200, now);
            filter.frequency.linearRampToValueAtTime(3000, now + 0.5);

            osc.disconnect();
            osc.connect(filter);
            filter.connect(gain);

            const osc2 = this.ctx.createOscillator();
            osc2.type = 'sawtooth';
            osc2.frequency.value = freq * 1.005;
            const gain2 = this.ctx.createGain();
            osc2.connect(gain2);
            gain2.connect(filter);
            
            osc.type = 'sawtooth';
            osc.frequency.value = freq;

            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(0.5, now + 0.4);
            gain.gain.setValueAtTime(0.5, now + duration - 0.2);
            gain.gain.linearRampToValueAtTime(0, now + duration);

            osc.start(now);
            osc.stop(now + duration + 0.5);
            osc2.start(now);
            osc2.stop(now + duration + 0.5);
        }
    }
}

/**
 * Visualizer & UI Controller
 */
const pianoEl = document.getElementById('piano');
const westernDisplay = document.getElementById('western-name');
const carnaticDisplay = document.getElementById('carnatic-name');
const noteDisplay = document.getElementById('current-note');
const displayPanel = document.getElementById('display-panel');
const scaleSelect = document.getElementById('scale-select');

const keyMap = {};

function renderKeyboard() {
    const startOctave = 3; 
    const numOctaves = 3; 
    const whiteNotes = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
    
    let whiteKeyIndex = 0;

    for (let o = startOctave; o < startOctave + numOctaves; o++) {
        NOTES.forEach(note => {
            const isBlack = note.includes('#');
            const noteId = `${note}${o}`;
            
            const key = document.createElement('div');
            key.className = `key ${isBlack ? 'black' : 'white'}`;
            key.dataset.note = noteId;

            key.addEventListener('mousedown', () => manualPlay(noteId));

            if (!isBlack) {
                pianoEl.appendChild(key);
                keyMap[noteId] = key;
                whiteKeyIndex++;
            } else {
                const leftPos = (whiteKeyIndex * 50) - 17; 
                key.style.left = `${leftPos}px`;
                pianoEl.appendChild(key);
                keyMap[noteId] = key;
            }
        });
    }
    // Add final C (C6)
    const endC = document.createElement('div');
    endC.className = 'key white';
    endC.dataset.note = `C${startOctave + numOctaves}`;
    endC.addEventListener('mousedown', () => manualPlay(`C${startOctave + numOctaves}`));
    pianoEl.appendChild(endC);
    keyMap[`C${startOctave + numOctaves}`] = endC;
}

function highlightKey(noteId) {
    document.querySelectorAll('.key.active').forEach(k => k.classList.remove('active'));
    
    if (keyMap[noteId]) {
        keyMap[noteId].classList.add('active');
        keyMap[noteId].scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
    }
}

function manualPlay(noteId) {
    const note = noteId.slice(0, -1);
    const octave = parseInt(noteId.slice(-1));
    audio.playTone(note, octave, 0.5);
    highlightKey(noteId);
    noteDisplay.textContent = `Manual: ${noteId}`;
}

function populateScaleDropdown() {
    SCALES.forEach((scale, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.text = `${scale.name}`;
        scaleSelect.appendChild(option);
    });
    
    // Update display when selection changes
    scaleSelect.addEventListener('change', () => {
        const idx = scaleSelect.value;
        updateDisplay(SCALES[idx], "...");
    });
}

/**
 * Sequencer / Tutorial Logic
 */
let isPlaying = false;
let currentIntervalIndex = 0;
let playTimeout = null;

const audio = new AudioEngine();

function getScaleNotes(rootIndex, type) {
    // Choose intervals based on scale type
    const intervals = type === 'minor' ? INTERVALS_MINOR : INTERVALS_MAJOR;
    
    const notes = [];
    intervals.forEach(interval => {
        const degreeIndex = (rootIndex + interval) % 12;
        const octaveOffset = Math.floor((rootIndex + interval) / 12);
        notes.push({
            note: NOTES[degreeIndex],
            octave: 4 + octaveOffset // Tutorial plays in Octave 4
        });
    });
    return notes;
}

function playNextNote() {
    if (!isPlaying) return;

    // Get selected scale from Dropdown
    const selectedScaleIndex = parseInt(scaleSelect.value);
    const currentScale = SCALES[selectedScaleIndex];
    const rootIndex = NOTES.indexOf(currentScale.root);
    
    // Pass type to get correct intervals
    const scaleNotes = getScaleNotes(rootIndex, currentScale.type);

    // If we finished the scale
    if (currentIntervalIndex >= scaleNotes.length) {
        // Reset to loop the same scale
        currentIntervalIndex = 0;
        
        playTimeout = setTimeout(() => {
             updateDisplay(currentScale, "...");
             playNextNote();
        }, 1000);
        return;
    }

    const noteObj = scaleNotes[currentIntervalIndex];
    const noteId = `${noteObj.note}${noteObj.octave}`;

    updateDisplay(currentScale, noteId);

    const bpm = parseInt(document.getElementById('speed').value);
    const secondsPerBeat = 60 / bpm;
    const duration = secondsPerBeat * 0.9;

    audio.playTone(noteObj.note, noteObj.octave, duration);
    highlightKey(noteId);

    currentIntervalIndex++;
    playTimeout = setTimeout(playNextNote, secondsPerBeat * 1000);
}

function updateDisplay(scale, currentNoteId) {
    westernDisplay.textContent = scale.name;
    carnaticDisplay.textContent = scale.carnatic;
    noteDisplay.textContent = `Playing: ${currentNoteId}`;
    displayPanel.classList.add('playing');
}

function startTutorial() {
    if (isPlaying) return;
    
    if (audio.ctx.state === 'suspended') {
        audio.ctx.resume();
    }

    isPlaying = true;
    currentIntervalIndex = 0;
    
    const selectedInst = document.getElementById('instrument').value;
    audio.setInstrument(selectedInst);

    playNextNote();
}

function stopTutorial() {
    isPlaying = false;
    if (playTimeout) clearTimeout(playTimeout);
    displayPanel.classList.remove('playing');
    noteDisplay.textContent = "Stopped";
    document.querySelectorAll('.key.active').forEach(k => k.classList.remove('active'));
}

/**
 * Event Listeners & Initialization
 */

document.getElementById('btn-play').addEventListener('click', startTutorial);
document.getElementById('btn-stop').addEventListener('click', stopTutorial);

document.getElementById('instrument').addEventListener('change', (e) => {
    audio.setInstrument(e.target.value);
});

document.getElementById('speed').addEventListener('input', (e) => {
    document.getElementById('speed-display').textContent = e.target.value;
});

// Init
renderKeyboard();
populateScaleDropdown();
// Set initial display to first scale
updateDisplay(SCALES[0], "...");

</script>
</body>
</html>